<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный Кабинет | Адвокат Медного Гроша</title>
    
    <style>
        :root { --gold: #d4af37; --bg: #f9f7f2; --bot-msg: #e3dec9; --orange: #d35400; --success: #27ae60; }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }

        /* Шапка с документами */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background: #fff; border-bottom: 2px solid var(--gold); }
        .logo { color: #b22222; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        .docs-panel { display: flex; gap: 10px; }
        .doc-btn { padding: 6px 15px; font-size: 0.8rem; border-radius: 5px; border: 1px dashed #ccc; color: #999; cursor: not-allowed; transition: 0.3s; }
        
        /* Эффект пульсации при заполнении */
        .pulse { border-color: var(--gold); color: var(--gold); animation: pulse-gold 1.5s infinite; }
        @keyframes pulse-gold { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .active-doc { background: var(--success); color: #fff; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Ресурс (Капсы) */
        .res-container { width: 150px; text-align: right; }
        .res-text { font-size: 10px; font-weight: bold; color: #666; margin-bottom: 2px; }
        .bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: 0.5s; background: var(--success); }

        /* Окно чата */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 15px; line-height: 1.5; }
        .bot { align-self: flex-start; background: var(--bot-msg); border-left: 5px solid var(--gold); }
        .user { align-self: flex-end; background: #fff; border: 1px solid #ddd; }

        /* Поле ввода */
        .input-box { padding: 20px; background: #fff; display: flex; gap: 10px; border-top: 1px solid #eee; }
        textarea { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 10px; outline: none; resize: none; }
        .btn-send { background: var(--orange); color: #fff; border: none; padding: 0 30px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-send:disabled { background: #ccc; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">⚖️ Адвокат Медного Гроша</div>
        
        <div class="docs-panel">
            <div id="doc-1" class="doc-btn">Претензия</div>
            <div id="doc-2" class="doc-btn">Роспотребнадзор</div>
            <div id="doc-3" class="doc-btn">Иск в суд</div>
        </div>

        <div class="res-container">
            <div class="res-text">РЕСУРС ИНТЕЛЛЕКТА</div>
            <div class="bar-bg"><div id="bar" class="bar-fill"></div></div>
        </div>
    </div>

    <div id="chat-window">
        <div class="msg bot">Приветствую! Я готов защитить ваши права. Опишите ситуацию, и я составлю план и документы.</div>
    </div>

    <div class="input-box">
        <textarea id="msg-input" placeholder="Введите обстоятельства дела..."></textarea>
        <button id="send-btn" class="btn-send">Отправить</button>
    </div>

    <script>
        const fp = btoa(`${window.screen.width}${navigator.userAgent}`).substring(0, 12);
        const API_URL = 'https://bothub-bridge.onrender.com/api/chat';
        const CHECK_URL = 'https://chea.onrender.com/verify-code';

        let history = []; // ВОТ ОНА — ПАМЯТЬ БОТА
        let limit = 0;

        async function updateUI() {
            const r = await fetch(CHECK_URL, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({fingerprint: fp}) 
            });
            const d = await r.json();
            if (d.success) {
                limit = d.caps_limit;
                const perc = (d.remaining / d.caps_limit) * 100;
                document.getElementById('bar').style.width = perc + '%';
                if (perc < 10) document.getElementById('send-btn').disabled = true;
            }
        }

        document.getElementById('send-btn').onclick = async () => {
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if (!val) return;

            // 1. Отображаем сообщение юзера
            const win = document.getElementById('chat-window');
            win.innerHTML += `<div class="msg user">${val}</div>`;
            input.value = '';
            
            // 2. Добавляем в историю (чтобы бот помнил!)
            history.push({ role: "user", content: val });

            // 3. Анимация кнопок в шапке
            const btn1 = document.getElementById('doc-1');
            btn1.classList.add('pulse');
            btn1.innerText = "Формирую...";

            try {
                // 4. Шлем ВСЮ историю переписки
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: history }) 
                });
                
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;

                // 5. Сохраняем ответ бота в историю
                history.push({ role: "assistant", content: aiMsg });

                // 6. Выводим ответ
                win.innerHTML += `<div class="msg bot">${aiMsg}</div>`;
                win.scrollTop = win.scrollHeight;

                // 7. Списание капсов (по длине ответа для теста)
                await fetch(CHECK_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ fingerprint: fp, usage: aiMsg.length * 5 })
                });
                
                // Активируем кнопку документа, если диалог продвинулся
                if(history.length > 4) {
                    btn1.classList.remove('pulse');
                    btn1.classList.add('active-doc');
                    btn1.innerText = "Скачать Претензию";
                }

                updateUI();
            } catch (e) { console.error("Ошибка:", e); }
        };

        updateUI();
    </script>
</body>
</html>
