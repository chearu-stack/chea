<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный Кабинет | Адвокат Медного Гроша</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --gold: #d4af37; --bg: #f9f7f2; --bot-msg: #e3dec9; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: #fff; border-bottom: 2px solid var(--gold); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { color: #b22222; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .caps-info { background: #eee; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; color: #555; }
        .main-container { max-width: 1000px; margin: 20px auto; height: calc(100vh - 120px); display: flex; flex-direction: column; background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        #chat-window { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 80%; padding: 15px; border-radius: 10px; line-height: 1.5; }
        .bot { align-self: flex-start; background: var(--bot-msg); border-left: 5px solid var(--gold); }
        .user { align-self: flex-end; background: #eee; border: 1px solid #ddd; }
        .input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 15px; }
        textarea { flex: 1; border: 1px solid #ccc; border-radius: 5px; padding: 12px; resize: none; outline: none; }
        .send-btn { background: #d35400; color: white; border: none; padding: 0 30px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .send-btn:disabled { background: #ccc; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="fas fa-balance-scale"></i> Адвокат Медного Гроша</div>
        <div id="caps-counter" class="caps-info">Загрузка лимита...</div>
    </div>

    <div class="main-container">
        <div id="chat-window">
            <div class="message bot">Система готова. Введите ваш вопрос для анализа.</div>
        </div>
        <div class="input-area">
            <textarea id="user-input" rows="2" placeholder="Ваш вопрос..."></textarea>
            <button id="send-btn" class="send-btn">Отправить</button>
        </div>
    </div>

   <script>
        // --- 1. ГЕНЕРАЦИЯ ОТПЕЧАТКА (FP) ---
        const getFP = () => {
            const s = window.screen;
            const b = navigator.userAgent;
            return btoa(`${s.width}${s.height}${b}${s.colorDepth}`).substring(0, 12);
        };
        const userFP = getFP();

        const CHEA_API_VERIFY = 'https://chea.onrender.com/verify-code';
        const CHEA_API_STATUS = 'https://chea.onrender.com/check-status';
        const BRIDGE_URL = 'https://bothub-bridge.onrender.com/api/chat';

        const capsInfo = document.getElementById('caps-counter');
        const sendBtn = document.getElementById('send-btn');
        let activeCode = null; // Сюда подтянем код из базы по отпечатку

        // --- 2. СИНХРОНИЗАЦИЯ ДОСТУПА И КАПСОВ ---
        async function syncCaps() {
            try {
                // Сначала проверяем статус по FP и получаем код
                const statusRes = await fetch(`${CHEA_API_STATUS}?fp=${userFP}`);
                const statusData = await statusRes.json();

                if (statusData.active) {
                    // Если активен, вызываем проверку лимитов
                    // Мы шлем FP вместо кода, сервер должен это понять
                    const res = await fetch(CHEA_API_VERIFY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fingerprint: userFP }) 
                    });
                    
                    const d = await res.json();
                    if (d.success) {
                        activeCode = d.code; // Запоминаем код для списания
                        capsInfo.innerText = `Лимит: ${d.remaining} капсов`;
                        sendBtn.disabled = false;
                        return d.remaining;
                    }
                }
                
                capsInfo.innerText = "Доступ ограничен";
                sendBtn.disabled = true;
                return 0;

            } catch (e) {
                capsInfo.innerText = "Ошибка связи";
                sendBtn.disabled = true;
                return 0;
            }
        }

        // --- 3. ОТПРАВКА СООБЩЕНИЯ ---
        sendBtn.onclick = async () => {
            const text = document.getElementById('user-input').value.trim();
            if (!text || !activeCode) return;

            sendBtn.disabled = true;
            const win = document.getElementById('chat-window');
            win.innerHTML += `<div class="message user">${text}</div>`;
            document.getElementById('user-input').value = '';

            try {
                const res = await fetch(BRIDGE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: [{role: 'user', content: text}] })
                });
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;

                win.innerHTML += `<div class="message bot">${aiMsg}</div>`;
                win.scrollTop = win.scrollHeight;

                // Списание капсов через сервер
                await fetch(CHEA_API_VERIFY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprint: userFP, usage: aiMsg.length })
                });
                syncCaps();
            } catch (err) {
                alert("Ошибка лимита или связи");
            } finally {
                sendBtn.disabled = false;
            }
        };

        syncCaps();
    </script>
</body>
</html>
