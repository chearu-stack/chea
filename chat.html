<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный Кабинет | Адвокат Медного Гроша</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --gold: #d4af37; --bg: #f9f7f2; --bot-msg: #e3dec9; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: #fff; border-bottom: 2px solid var(--gold); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { color: #b22222; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .caps-info { background: #eee; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; color: #555; }
        .main-container { max-width: 1000px; margin: 20px auto; height: calc(100vh - 120px); display: flex; flex-direction: column; background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        #chat-window { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 80%; padding: 15px; border-radius: 10px; line-height: 1.5; }
        .bot { align-self: flex-start; background: var(--bot-msg); border-left: 5px solid var(--gold); }
        .user { align-self: flex-end; background: #eee; border: 1px solid #ddd; }
        .input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 15px; }
        textarea { flex: 1; border: 1px solid #ccc; border-radius: 5px; padding: 12px; resize: none; outline: none; }
        .send-btn { background: #d35400; color: white; border: none; padding: 0 30px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .send-btn:disabled { background: #ccc; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="fas fa-balance-scale"></i> Адвокат Медного Гроша</div>
        <div id="caps-counter" class="caps-info">Загрузка лимита...</div>
    </div>

    <div class="main-container">
        <div id="chat-window">
            <div class="message bot">Система готова. Введите ваш вопрос для анализа.</div>
        </div>
        <div class="input-area">
            <textarea id="user-input" rows="2" placeholder="Ваш вопрос..."></textarea>
            <button id="send-btn" class="send-btn">Отправить</button>
        </div>
    </div>

    <script>
        const CHEA_API = 'https://chea.onrender.com/verify-code';
        const BRIDGE_URL = 'https://bothub-bridge.onrender.com/api/chat';
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('access_code');

        const capsInfo = document.getElementById('caps-counter');
        const sendBtn = document.getElementById('send-btn');

        async function syncCaps() {
            if (!code) { capsInfo.innerText = "Код не найден"; return 0; }
            try {
                const r = await fetch(CHEA_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                
                const d = await r.json();
                if (d.success) {
                    capsInfo.innerText = `Лимит: ${d.remaining} капсов`;
                    return d.remaining;
                } else {
                    capsInfo.innerText = "Ошибка кода";
                }
            } catch (e) {
                capsInfo.innerText = "Ошибка связи";
            }
            return 0;
        }

        sendBtn.onclick = async () => {
            const text = document.getElementById('user-input').value.trim();
            if (!text || !code) return;

            sendBtn.disabled = true;
            const win = document.getElementById('chat-window');
            win.innerHTML += `<div class="message user">${text}</div>`;
            document.getElementById('user-input').value = '';

            try {
                const res = await fetch(BRIDGE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: [{role: 'user', content: text}] })
                });
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;

                win.innerHTML += `<div class="message bot">${aiMsg}</div>`;
                win.scrollTop = win.scrollHeight;

                await fetch(CHEA_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, usage: aiMsg.length })
                });
                syncCaps();
            } catch (err) {
                alert("Ошибка моста или лимита");
            } finally {
                sendBtn.disabled = false;
            }
        };

        syncCaps();
    </script>
</body>
</html>
