<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный Кабинет | Адвокат Медного Гроша</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --gold: #d4af37; --bg: #f9f7f2; --bot-msg: #e3dec9; --danger: #e74c3c; --success: #2ecc71; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: #fff; border-bottom: 2px solid var(--gold); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { color: #b22222; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        /* СТИЛЬ РЕСУРСА (Вместо капсов) */
        .resource-container { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .resource-label { font-size: 0.7rem; font-weight: bold; color: #777; text-transform: uppercase; }
        .bar-bg { width: 150px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; border: 1px solid #ddd; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.5s ease, background 0.5s ease; }

        .main-container { max-width: 1000px; margin: 20px auto; height: calc(100vh - 120px); display: flex; flex-direction: column; background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; position: relative; }
        #chat-window { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        
        .message { max-width: 80%; padding: 15px; border-radius: 10px; line-height: 1.5; position: relative; }
        .bot { align-self: flex-start; background: var(--bot-msg); border-left: 5px solid var(--gold); }
        .user { align-self: flex-end; background: #eee; border: 1px solid #ddd; }
        
        /* ЭФФЕКТ ЗАГРУЗКИ (КОРОВА) */
        .thinking { font-style: italic; color: #888; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        
        .input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 15px; background: #fff; }
        textarea { flex: 1; border: 1px solid #ccc; border-radius: 5px; padding: 12px; resize: none; outline: none; font-size: 1rem; }
        .send-btn { background: #d35400; color: white; border: none; padding: 0 30px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .send-btn:hover { background: #e67e22; }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="fas fa-balance-scale"></i> Адвокат Медного Гроша</div>
        <div class="resource-container">
            <div class="resource-label" id="res-text">Интеллектуальный ресурс</div>
            <div class="bar-bg"><div id="res-bar" class="bar-fill"></div></div>
        </div>
    </div>

    <div class="main-container">
        <div id="chat-window">
            <div class="message bot">Система готова. Я проанализирую вашу ситуацию с точки зрения законодательства РФ. Введите ваш вопрос.</div>
        </div>
        <div class="input-area">
            <textarea id="user-input" rows="2" placeholder="Напишите обстоятельства дела..."></textarea>
            <button id="send-btn" class="send-btn">Отправить</button>
        </div>
    </div>

    <script>
        const getFP = () => {
            const s = window.screen;
            const b = navigator.userAgent;
            return btoa(`${s.width}${s.height}${b}${s.colorDepth}`).substring(0, 12);
        };
        const userFP = getFP();

        const CHEA_API_VERIFY = 'https://chea.onrender.com/verify-code';
        const CHEA_API_STATUS = 'https://chea.onrender.com/check-status';
        const BRIDGE_URL = 'https://bothub-bridge.onrender.com/api/chat';

        const resBar = document.getElementById('res-bar');
        const sendBtn = document.getElementById('send-btn');
        const win = document.getElementById('chat-window');
        let activeCode = null;

        async function syncCaps() {
            try {
                const statusRes = await fetch(`${CHEA_API_STATUS}?fp=${userFP}`);
                const statusData = await statusRes.json();

                if (statusData.active) {
                    const res = await fetch(CHEA_API_VERIFY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fingerprint: userFP }) 
                    });
                    
                    const d = await res.json();
                    if (d.success) {
                        activeCode = d.code;
                        const percent = Math.max(0, Math.round((d.remaining / d.caps_limit) * 100));
                        
                        // Обновляем визуальную шкалу
                        resBar.style.width = percent + '%';
                        resBar.style.background = percent > 50 ? '#2ecc71' : (percent > 20 ? '#f1c40f' : '#e74c3c');
                        
                        sendBtn.disabled = false;
                        return d.remaining;
                    }
                }
                document.getElementById('res-text').innerText = "Доступ ограничен";
                sendBtn.disabled = true;
            } catch (e) {
                console.error("Connection error");
            }
            return 0;
        }

        sendBtn.onclick = async () => {
            const text = document.getElementById('user-input').value.trim();
            if (!text || !activeCode) return;

            sendBtn.disabled = true;
            win.innerHTML += `<div class="message user">${text}</div>`;
            document.getElementById('user-input').value = '';
            win.scrollTop = win.scrollHeight;

            // --- ЗАПУСК "КОРОВЫ" (ИНДИКАТОРА) ---
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message bot thinking';
            thinkingDiv.innerHTML = `<i class="fas fa-balance-scale fa-spin"></i> <span id="think-txt">Анализирую запрос...</span>`;
            win.appendChild(thinkingDiv);
            
            const phrases = ["Изучаю статьи закона...", "Поиск судебной практики...", "Формирую правовую позицию...", "Проверка юридических рисков..."];
            let i = 0;
            const stepInterval = setInterval(() => {
                const t = document.getElementById('think-txt');
                if (t) t.innerText = phrases[++i % phrases.length];
            }, 3000);

            try {
                const res = await fetch(BRIDGE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: [{role: 'user', content: text}] })
                });
                
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;

                clearInterval(stepInterval);
                thinkingDiv.remove(); // Убираем индикатор перед ответом

                win.innerHTML += `<div class="message bot">${aiMsg}</div>`;
                win.scrollTop = win.scrollHeight;

                await fetch(CHEA_API_VERIFY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprint: userFP, usage: aiMsg.length })
                });
                syncCaps();
            } catch (err) {
                clearInterval(stepInterval);
                thinkingDiv.innerHTML = "Ошибка связи. Попробуйте позже.";
            } finally {
                sendBtn.disabled = false;
            }
        };

        syncCaps();
    </script>
</body>
</html>
